# ComfyUI Timesaver Nodes

[English](README.md) | [Русский](README.ru.md)

Эти пользовательские узлы для ComfyUI расширяют возможности платформы инструментами для обработки изображений и видео, генерации текста, транскрипции аудио и управления файлами. Они разработаны для бесшовной интеграции в рабочие процессы ComfyUI и удовлетворяют различные творческие и технические потребности.

Репозиторий: [https://github.com/AlexYez/comfyui-timesaver](https://github.com/AlexYez/comfyui-timesaver)

## Установка

Для установки пользовательских узлов выполните следующие шаги:

1. Клонируйте репозиторий или загрузите файлы узлов.
2. Поместите файлы узлов в директорию `custom_nodes` вашей установки ComfyUI.
3. Перезапустите ComfyUI для загрузки новых узлов.

## Описания узлов

### TS_CubemapFacesToEquirectangularNode

- **Назначение**: Преобразует шесть изображений граней кубической карты (передняя, правая, задняя, левая, верхняя, нижняя) в одно эквиректилинейное изображение с использованием библиотеки py360convert.
- **Входные данные**:
  - `front`: Изображение (передняя грань)
  - `right`: Изображение (правая грань)
  - `back`: Изображение (задняя грань)
  - `left`: Изображение (левая грань)
  - `top`: Изображение (верхняя грань)
  - `bottom`: Изображение (нижняя грань)
  - `output_width`: Целое число (по умолчанию: 2048, мин: 64, макс: 8192, шаг: 64)
  - `output_height`: Целое число (по умолчанию: 1024, мин: 32, макс: 4096, шаг: 32)
- **Выходные данные**:
  - `IMAGE`: Эквиректилинейное изображение
- **Использование**: Подходит для преобразования проекций кубической карты в эквиректилинейный формат для визуализации на 360 градусов или дальнейшей обработки.

### TS_EDLToYouTubeChaptersNode

- **Назначение**: Преобразует файл списка решений редактирования (EDL) в строку глав YouTube, извлекая таймкоды и заголовки.
- **Входные данные**:
  - `edl_file_path`: Строка (путь к файлу EDL)
- **Выходные данные**:
  - `STRING`: Строка глав YouTube (например, "00:00 Введение\n03:15 Часть 1")
- **Использование**: Упрощает рабочие процессы видеомонтажа, генерируя маркеры глав YouTube из приложений.

### TS_FilePathLoader

- **Назначение**: Извлекает пути к файлам из указанной папки, поддерживая форматы изображений и видео, такие как .mp4 и .png.
- **Входные данные**:
  - `folder_path`: String (путь к папке)
  - `index`: Integer (по умолчанию: 2, min: 1, шаг: 1)
- **Выходные данные**:
  - `STRING`: Полный путь к файлу
  - `STRING`: Имя файла без расширения
- **Usage**: 
Облегчает выбор и загрузку файлов в рабочих процессах ComfyUI.

### TS_Qwen3_Node

- **Назначение**: Использует языковую модель Qwen3 для генерации текста, оптимизированную для создания детализированных промптов для изображений.
- **Inputs**:
  - `model_name`: String (options: "Qwen/Qwen3-1.7B", "Qwen/Qwen3-4B", etc., default: "Qwen/Qwen3-1.7B")  - `system`: String (системный промпт, multiline, default: predefined промпт для генерации изображений)
  - `prompt`: String (пользовательский промпт, multiline, default: "яблоки на столе")  - `seed`: Integer (default: 2048, min: 64, max: 8192, step: 64)
  - `max_new_tokens`: Integer (default: 4096, min: 512, max: 32768, step: 64)
  - `enable_thinking`: Boolean (default: False, default: True)  - `precision`: String (default: 0.0, min: 0.0, max: 10.0, step: 0.01)
- **Outputs**:
  - `STRING`: Generated text
- **Usage**: 
Улучшает творческие проекты, создавая описательные промпты для моделей генерации изображений.

### TS_Video_Upscale_With_Model

- **Назначение**: Увеличивает масштаб кадров видео с использованием заданной модели с эффективным управлением памятью и интеграцией Spandrel.
- **Входные данные**:
  - `model_name`: Строка (из списка upscale_models)
  - `images`: IMAGE (кадры видео)
  - `upscale_method`: Строка (варианты: "nearest-exact", "bilinear" и т.д.)
  - `factor`: Число с плавающей точкой (по умолчанию: 2.0, мин: 0.1, макс: 8.0, шаг: 0.1)
  - `device_strategy`: Строка (варианты: "auto", "load_unload_each_frame" и т.д., по умолчанию: "auto")
- **Выходные данные**:
  - `IMAGE`: Увеличенные кадры видео
- **Использование**: Повышает качество видео с гибкими опциями управления устройством для обработки на GPU/CPU.

### TS_VideoDepth

- **Назначение**: Генерирует карты глубины для кадров видео с использованием модели VideoDepthAnything с настраиваемой постобработкой.
- **Входные данные**:
  - `images`: IMAGE (кадры видео)
  - `model_filename`: Строка (варианты: "video_depth_anything_vits.pth" и т.д., по умолчанию: "video_depth_anything_vitl.pth")
  - `input_size`: Целое число (по умолчанию: 518, мин: 64, макс: 4096, шаг: 2)
  - `max_res`: Целое число (по умолчанию: 1280, мин: -1, макс: 8192, шаг: 1)
  - `precision`: Строка (варианты: "fp16", "fp32", по умолчанию: "fp16")
  - `colormap`: Строка (варианты: "gray", "inferno" и т.д., по умолчанию: "gray")
  - `dithering_strength`: Число с плавающей точкой (по умолчанию: 0.005, мин: 0.0, макс: 0.016, шаг: 0.0001)
  - `apply_median_blur`: Логическое (по умолчанию: True)
  - `upscale_algorithm`: Строка (варианты: "Lanczos4", "Cubic" и т.д., по умолчанию: "Lanczos4")
- **Выходные данные**:
  - `IMAGE`: Изображения карт глубины
- **Использование**: Добавляет информацию о глубине к видео, полезно для 3D-эффектов или реконструкций.

### TS_EquirectangularToCubemapFacesNode

- **Назначение**: Преобразует эквиректилинейное изображение в шесть изображений граней кубической карты с использованием py360convert.
- **Входные данные**:
  - `image`: IMAGE (эквиректилинейное изображение)
  - `cube_size`: Целое число (по умолчанию: 512, мин: 64, макс: 4096, шаг: 64)
- **Выходные данные**:
  - `IMAGE`: Передняя грань
  - `IMAGE`: Правая грань
  - `IMAGE`: Задняя грань
  - `IMAGE`: Левая грань
  - `IMAGE`: Верхняя грань
  - `IMAGE`: Нижняя грань
- **Использование**: Удобно для преобразования в формат кубической карты для рендеринга или приложений VR.

### TSWhisper

- **Назначение**: Транскрибирует или переводит аудио с использованием модели Whisper, поддерживает генерацию SRT файлов.
- **Входные данные**:
  - `audio`: AUDIO
  - `output_filename_prefix`: Строка (по умолчанию: "transcribed_audio")
  - `task`: Строка (варианты: "transcribe", "translate_to_english", по умолчанию: "transcribe")
  - `source_language`: Строка (варианты: "auto", "en" и т.д., по умолчанию: "auto")
  - `save_srt_file`: Логическое (по умолчанию: True)
  - `precision`: Строка (варианты: "fp32", "fp16" и т.д., по умолчанию: "fp16")
  - `attn_implementation`: Строка (варианты: "eager", "sdpa", по умолчанию: зависит от системы)
  - `plain_text_format`: Строка (варианты: "single_block", "newline_per_segment", по умолчанию: "single_block")
  - `manual_chunk_length_s`: Число с плавающей точкой (по умолчанию: 28.0, мин: 5.0, макс: 30.0, шаг: 1.0)
  - `manual_chunk_overlap_s`: Число с плавающей точкой (по умолчанию: 4.0, мин: 0.0, макс: 10.0, шаг: 0.5)
  - `output_dir`: Строка (опционально, по умолчанию: директория вывода ComfyUI)
- **Выходные данные**:
  - `STRING`: Содержимое SRT
  - `STRING`: Чистый текст транскрипции
- **Использование**: Автоматизирует транскрипцию аудио и создание субтитров для мультимедийных проектов.

### TS_ImageResize

- **Назначение**: Изменяет размер изображений с гибкими опциями для размеров, масштабирования и управления пропорциями.
- **Входные данные**:
  - `pixels`: IMAGE
  - `target_width`: Целое число (по умолчанию: 0, мин: 0, макс: 8192, шаг: 8)
  - `target_height`: Целое число (по умолчанию: 0, мин: 0, макс: 8192, шаг: 8)
  - `smaller_side`: Целое число (по умолчанию: 0, мин: 0, макс: 8192, шаг: 8)
  - `larger_side`: Целое число (по умолчанию: 0, мин: 0, макс: 8192, шаг: 8)
  - `scale_factor`: Число с плавающей точкой (по умолчанию: 0.0, мин: 0.0, макс: 10.0, шаг: 0.01)
  - `keep_proportion`: Логическое (по умолчанию: True)
  - `upscale_method`: Строка (варианты: "nearest-exact", "bilinear" и т.д., по умолчанию: "bicubic")
  - `divisible_by`: Целое число (по умолчанию: 1, мин: 1, макс: 256, шаг: 1)
- **Выходные данные**:
  - `IMAGE`: Измененное изображение
  - `INT`: Новая ширина
  - `INT`: Новая высота
- **Использование**: Адаптирует размеры изображений для совместимости с различными моделями или требованиями отображения.

### TS_DownloadFilesNode

- **Назначение**: Загружает файлы по URL с поддержкой возобновления, повторных попыток и проверки размера, с опциональным использованием токена Hugging Face.
- **Входные данные**:
  - `file_list`: Строка (многострочная, формат: "URL /path/to/save_directory")
  - `skip_existing`: Логическое (по умолчанию: True)
  - `verify_size`: Логическое (по умолчанию: True)
  - `chunk_size_kb`: Целое число (по умолчанию: 4096, мин: 1, макс: 65536, шаг: 1)
  - `hf_token`: Строка (опционально, по умолчанию: "")
- **Выходные данные**: Нет (загружает файлы в указанные директории)
- **Использование**: Упрощает получение внешних ресурсов, таких как модели или наборы данных, для рабочих процессов ComfyUI.

## Зависимости

- `py360convert`
- `torch`
- `numpy`
- `transformers`
- `huggingface_hub`
- `spandrel` (для TS_Video_Upscale_With_Model)
- `VideoDepthAnything` (для TS_VideoDepth)
- `torchaudio` (для TSWhisper)
- `srt` (для TSWhisper)
- `requests`
- `tqdm`
- `torchvision` (опционально, для TS_ImageResize с Lanczos)

Установите эти библиотеки в вашей среде для обеспечения полной функциональности.

## Устранение неполадок

- **Ошибки загрузки моделей**: Убедитесь, что файлы моделей загружены и доступны. Проверьте пути и разрешения.
- **Проблемы с памятью**: Для обработки видео или больших изображений обеспечьте достаточный объем памяти GPU. При необходимости настройте стратегии устройств.
- **Конфликты зависимостей**: Убедитесь в совместимости зависимостей, версии Python и ComfyUI.

## Вклад

Вклад приветствуется! Отправляйте issues или pull requests на репозиторий GitHub.

## Лицензия

Эти пользовательские узлы выпущены под [лицензией MIT](LICENSE).